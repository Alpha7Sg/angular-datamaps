"use strict";angular.module("datamaps",[]),angular.module("datamaps").directive("datamap",["$window",function(a){return{restrict:"EA",scope:{map:"=",plugins:"=?",zoomable:"@?",onClick:"&?",pluginData:"=",api:"=?"},link:function(b,c,d){function e(){return{element:c[0],scope:"usa",height:b.height,width:b.width,aspectRatio:b.aspectRatio,fills:{defaultFill:"#b9b9b9"},data:{},done:function(a){function c(){d3.event.scale==g&&a.svg.selectAll("g").attr("transform","translate("+d3.event.translate+")scale("+g+")")}f=d3.behavior.zoom().scaleExtent([1,10]).on("zoom",c),angular.isDefined(d.onClick)&&a.svg.selectAll(".datamaps-subunit").on("click",function(a){b.onClick()(a)}),angular.isDefined(d.zoomable)&&a.svg.call(f)}}}var f,g=1;b.api={refresh:function(a){b.api.updateWithOptions(a)},updateWithOptions:function(c){b.api.clearElement(),b.width=(c.options||{}).width||null,b.height=(c.options||{}).height||(b.width?.5*b.width:null),b.aspectRatio=(c.options||{}).aspectRatio||null,b.legendHeight=(c.options||{}).legendHeight||50,b.mapOptions=e(),b.mapOptions=angular.extend(b.mapOptions,c),b.datamap=new Datamap(b.mapOptions),b.mapOptions.responsive?a.addEventListener("resize",b.api.resize):a.removeEventListener("resize",b.api.resize),b.api.updatePlugins(b.datamap),b.api.refreshOptions(c.options),b.api.updateWithData(c.data)},updatePlugins:function(a){if(b.plugins){var c=b.pluginData||{};angular.forEach(b.plugins,function(b,d){a.addPlugin(d,b),a[d](c[d])})}},refreshOptions:function(a){a&&(a.labels&&b.datamap.labels({labelColor:a.labelColor?a.labelColor:"#333333",fontSize:a.labelSize?a.labelSize:12}),a.legend&&b.datamap.legend())},resize:function(){b.datamap.resize()},updateWithData:function(a){b.datamap.updateChoropleth(a),b.api.updatePlugins(b.datamap)},clearElement:function(){b.datamap=null,c.empty().css({position:"relative",display:"block","padding-bottom":b.legendHeight+"px"})},zoomClick:function(a,d){var a=a||"reset",d=d||1.2,e=[c[0].offsetWidth/2,c[0].offsetHeight/2],h=f.scale(),i=f.translate(),j=f.scaleExtent();if("reset"===a)return f.scale(1).translate([0,0]),b.datamap.svg.selectAll("g").attr("transform","translate("+[0,0]+")scale(1)"),!1;"out"===a&&(d=1/d);var k=h*d;if(k<j[0]||k===j[1])return!1;var l=Math.max(j[0],Math.min(j[1],k));l!=k&&(k=l,d=k/h);var m=(i[0]-e[0])*d+e[0],n=(i[1]-e[1])*d+e[1];f.scale(k).translate([m,n]),g=k,b.datamap.svg.selectAll("g").attr("transform","translate("+[m,n]+")scale("+k+")")}},b.$watch("map",function(a,c){a&&!angular.equals({},a)&&(!b.datamap||angular.equals(a.data,c.data)?b.api.refresh(a):(a.options||{}).staticGeoData?b.api.updateWithData(a.data):b.api.refresh(a))},!0),b.$watch("pluginData",function(){b.api.updatePlugins(b.datamap)},!0)}}}]);